<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Secure Face Attendance</title>
    <!-- AWS SDK for Cognito -->
    <script src="https://sdk.amazonaws.com/js/aws-sdk-2.1259.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/amazon-cognito-identity-js@6.3.7/dist/amazon-cognito-identity.min.js"></script>
    <style>
        body { font-family: 'Segoe UI', Arial, sans-serif; max-width: 800px; margin: 40px auto; text-align: center; background-color: #f4f6f8; }
        .container { background: white; padding: 30px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        
        /* Login Form */
        #loginSection { max-width: 350px; margin: 0 auto; }
        input { width: 100%; padding: 12px; margin: 10px 0; border: 1px solid #ddd; border-radius: 6px; box-sizing: border-box; }
        
        /* Dashboard */
        #dashboardSection { display: none; }
        #video { width: 100%; max-width: 480px; height: 360px; border: 3px solid #007bff; border-radius: 10px; background: #000; }
        
        /* Buttons */
        button { width: 100%; padding: 12px; margin: 10px 0; font-size: 16px; border-radius: 6px; cursor: pointer; border: none; font-weight: bold; transition: opacity 0.2s; }
        .btn-primary { background: #007bff; color: white; }
        .btn-success { background: #28a745; color: white; }
        .btn-warning { background: #ffc107; color: black; }
        .btn-danger { background: #dc3545; color: white; width: auto; padding: 8px 16px; margin-top: 20px; }
        button:disabled { opacity: 0.6; cursor: not-allowed; }
        
        /* Status & Admin Panel */
        #status { margin: 20px 0; padding: 15px; border-radius: 8px; font-weight: 500; display: none; }
        .success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .loading { background: #fff3cd; color: #856404; border: 1px solid #ffeeba; }
        
        #adminPanel { display: none; margin-top: 20px; padding: 20px; border: 2px dashed #ffc107; border-radius: 8px; background: #fffcf5; }
        
        h1 { color: #333; margin-bottom: 30px; }
        h3 { margin-top: 0; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîê Secure Face Attendance</h1>
        
        <!-- Login Section -->
        <div id="loginSection">
            <h3>Login Required</h3>
            <input type="text" id="username" placeholder="Username (e.g. admin)">
            <input type="password" id="password" placeholder="Password">
            <button onclick="login()" class="btn-primary">Login</button>
            <div id="loginError" style="color: red; margin-top: 10px;"></div>
        </div>

        <!-- Dashboard Section -->
        <div id="dashboardSection">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <span id="welcomeMsg" style="font-weight: bold; font-size: 18px;"></span>
                <button onclick="logout()" class="btn-danger">Logout</button>
            </div>

            <div id="adminPanel">
                <h3>üëë Admin Registration Mode</h3>
                <input type="text" id="regUserId" placeholder="Enter New User ID (e.g. 20BCS001)" style="max-width: 300px;">
                <p style="font-size: 0.9em; color: #666;">Enter ID below and capture face to register.</p>
            </div>

            <video id="video" autoplay muted playsinline></video>
            
            <div style="margin-top: 20px;">
                <button id="startBtn" onclick="startCamera()" class="btn-primary" style="width: auto;">üì∑ Start Camera</button>
                <button id="captureBtn" onclick="captureFace()" class="btn-success" style="width: auto;" disabled>üì∏ Capture & Process</button>
            </div>

            <div id="status"></div>
        </div>
    </div>

    <script>
        // --- CONFIGURATION ---
        const POOL_DATA = {
            UserPoolId: 'ap-south-1_DBdAqQGEY',
            ClientId: '3vkoq7vms7pl11sbke5rh4plme'
        };
        const BUCKET_URL = 'https://face-attendance-project-001.s3.ap-south-1.amazonaws.com';
        // ---------------------

        // Cognito Setup
        const userPool = new AmazonCognitoIdentity.CognitoUserPool(POOL_DATA);
        let currentUser = null;
        let isAdmin = false;

        // Login Function
        function login() {
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            const errorDiv = document.getElementById('loginError');
            
            const authData = { Username: username, Password: password };
            const authDetails = new AmazonCognitoIdentity.AuthenticationDetails(authData);
            const userData = { Username: username, Pool: userPool };
            const cognitoUser = new AmazonCognitoIdentity.CognitoUser(userData);

            errorDiv.textContent = 'Logging in...';

            cognitoUser.authenticateUser(authDetails, {
                onSuccess: function(result) {
                    currentUser = result;
                    isAdmin = username.toLowerCase() === 'admin';
                    showDashboard(username);
                    
                    // Handle New Password Challenge (first login)
                },
                onFailure: function(err) {
                    errorDiv.textContent = err.message || JSON.stringify(err);
                },
                newPasswordRequired: function(userAttributes, requiredAttributes) {
                    // Auto-accept new password for demo simplicity
                    cognitoUser.completeNewPasswordChallenge(password, {}, {
                        onSuccess: function(result) {
                            currentUser = result;
                            isAdmin = username.toLowerCase() === 'admin';
                            showDashboard(username);
                        },
                        onFailure: function(err) {
                            errorDiv.textContent = err.message;
                        }
                    });
                }
            });
        }

        // Show Dashboard
        function showDashboard(username) {
            document.getElementById('loginSection').style.display = 'none';
            document.getElementById('dashboardSection').style.display = 'block';
            document.getElementById('welcomeMsg').textContent = `üëã Welcome, ${username}`;
            document.getElementById('adminPanel').style.display = isAdmin ? 'block' : 'none';
            
            const btn = document.getElementById('captureBtn');
            if(isAdmin) {
                btn.textContent = 'üë§ Register Face';
                btn.className = 'btn-warning';
            } else {
                btn.textContent = '‚úÖ Mark Attendance';
                btn.className = 'btn-success';
            }
        }

        // Logout
        function logout() {
            const userPool = new AmazonCognitoIdentity.CognitoUserPool(POOL_DATA);
            const cognitoUser = userPool.getCurrentUser();

            if (cognitoUser != null) {
                cognitoUser.signOut();
            }
            location.reload();
        }

        // Camera Logic
        const video = document.getElementById('video');
        
        async function startCamera() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ video: { width: 640, height: 480 } });
                video.srcObject = stream;
                document.getElementById('startBtn').disabled = true;
                document.getElementById('captureBtn').disabled = false;
                setStatus('Camera active. Position face and click Capture.', '');
            } catch(err) {
                setStatus('Camera Error: ' + err.message, 'error');
            }
        }

        // Capture & Upload
        function captureFace() {
            if(isAdmin && !document.getElementById('regUserId').value) {
                alert('Please enter a User ID for registration!');
                return;
            }

            setStatus('Processing...', 'loading');
            
            const canvas = document.createElement('canvas');
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            canvas.getContext('2d').drawImage(video, 0, 0);

            canvas.toBlob(async (blob) => {
                try {
                    // Determine upload path
                    let key;
                    if(isAdmin) {
                        const userId = document.getElementById('regUserId').value.trim();
                        key = `admin_faces/${userId}.jpg`;
                    } else {
                        const timestamp = new Date().toISOString().replace(/[:.]/g, '-');
                        key = `uploads/attendance-${timestamp}.jpg`;
                    }

                    // Direct Upload (Demo Mode)
                    const response = await fetch(`${BUCKET_URL}/${key}`, {
                        method: 'PUT',
                        body: blob,
                        headers: { 'Content-Type': 'image/jpeg' }
                    });

                    if(response.ok) {
                        if(isAdmin) {
                            setStatus(`‚úÖ User ${document.getElementById('regUserId').value} registered!`, 'success');
                            document.getElementById('regUserId').value = '';
                        } else {
                            setStatus('‚úÖ Attendance Marked Successfully!', 'success');
                        }
                    } else {
                        setStatus('‚ùå Upload Failed. Check console.', 'error');
                    }
                } catch(err) {
                    setStatus('Error: ' + err.message, 'error');
                }
            }, 'image/jpeg', 0.8);
        }

        function setStatus(msg, type) {
            const el = document.getElementById('status');
            el.textContent = msg;
            el.className = type;
            el.style.display = 'block';
        }
    </script>
</body>
</html>
